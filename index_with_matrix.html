<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <meta http-equiv="content-Type" content="text/html; charset=utf-8" />
    <meta name="description" content="Sustainable Energy Transitions Exploratorium #energy #SDG #sustainability #d3plus #dataviz #d3js @csaladenes" />
    <meta name="keywords" content="csaladenes, d3.js, data visualization, infographic, d3plus, d3, data visualization, mit oec, mit, mit atlas, macro connections, set, system dynamics, sustainable energy transitions, renewable energy, energy return on energy invested, eroei, eroi, sgouris sgouridis, denes csala, ssgouridis, dcsala, science, nature, article, d3.js, ipython, ugo bardi, ugo, peak oil, hubbert curve, carbon cap, emissions cap, fossil fuels, co2 emissions greenhouse gas emissions" />
    <meta property="og:image" content="http://netset.csaladen.es/netset_logo.png" />
	<meta property="twitter:image" content="http://netset.csaladen.es/netset_logo.png" />
    <meta property="og:description" content="Sustainable Energy Transitions Exploratorium #energy #SDG #sustainability #d3plus #dataviz #d3js @csaladenes" />
	<meta property="twitter:description" content="Sustainable Energy Transitions Exploratorium #energy #SDG #sustainability #d3plus #dataviz #d3js @csaladenes" />
    <meta property="og:title" content="Sustainable Energy Transitions Exploratorium" />
	<meta property="twitter:title" content="Sustainable Energy Transitions Exploratorium" />
    <meta http-equiv="content-Type" content="text/html; charset=utf-8" />
	<meta property="og:url" content="http://netset.csaladen.es"/>
	<meta property="twitter:url" content="http://netset.csaladen.es"/>
    <meta property="og:site_name" content="Sustainable Energy Transitions Exploratorium" />
    <meta property="fb:admins" content="100943737036023614165" />
	<link rel="shortcut icon" href="favicon.ico" />
	<link rel="publisher" href="https://plus.google.com/106181965793093327960" />
    <title>Sustainable Energy Transitions Exploratorium</title>
	<style>
@font-face {
	font-family: "Righteous";
	src: url(Righteous-Regular.ttf) format("truetype");
}
.logo, .viz, #social {
 	-webkit-transition: opacity 0.5s;
	  -moz-transition: opacity 0.5s;
	  -o-transition: opacity 0.5s;
	  -ms-transition: opacity 0.5s;
	  transition: opacity 0.5s;
}
.viz{
	width: -moz-calc(100% - 200px);
	width: -webkit-calc(100% - 200px);
	width: calc(100% - 200px);
}
a{
	font-family:Righteous;
	text-decoration:none;
}
a:hover{
	font-family:Righteous;
	text-decoration:underline;
}
a:visited{
	color: #444;
}
.logo:hover{
	cursor:pointer;
}
#social {
	text-decoration: none;
	padding-top:1px;
	white-space:nowrap;
	overflow:hidden;
}
.socialico{
	width:21px;
	height:21px;
}
.rotmenu {
  -webkit-transition: -webkit-transform .8s ease-in-out;
  transition: transform .8s ease-in-out;
}
.rotmenu:hover {
  -webkit-transform: rotate(-360deg);
  transform: rotate(-360deg);
}
</style>

<script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "505a26ad-d820-47bd-a500-7f49d04a30f5", doNotHash: false, doNotCopy: false, hashAddressBar: true,shorten:false});</script>

</head>

<!-- load D3js -->
<script src="d3.js"></script>

<!-- load topojson after D3js -->
<script src="d3.geo.projection.v0.min.js"></script>
<script src="topojson.v1.min.js"></script>

<!-- load D3plus after both -->
<script src="d3plus.js"></script>

<script src="jszip.min.js"></script>
<script src="JSZipUtils.min.js"></script>
<script src="svgexport.js"></script>

<body link="#444">
<!-- create container element for visualization -->
<a id="pngdownload" href="" download="" style="visibility:hidden;display:none;position:fixed;top:0px;left:0px;width:0px;height:0px;"></a>


<div style="position: fixed;
    left: 50%;
    top: 50%;
    height: 150px;
    margin-top: -168px;
    width: 150px;
    margin-left: -170px;" class="loading">
<img style="position: absolute;
    left: 0px;
    top: 0px;
    z-index: 49;
    height: 170px;
	width: 170px;
    margin-top: -45px;
	margin-left: -10px;" src="b.gif"/>
<img style="position: absolute;
    left: 0px;
    top: 0px;
    z-index: 50;
    height: 100px;
    width: 100px;
	margin-top: 0px;
	margin-left: 25px;
    border:none" src="netset_logo.png"/>
</div>

<div style="position: fixed;
    right: 20px;
    top: 70px;
    z-index: 101;
	opacity: 0;
    height: 100%
	width:190px;" class="logo">
	<img style="position: absolute;
    right: 60px;
    top:250px;
    height: 52px;
	border: solid 1px #888; background-color:rgba(251,212,31,1);
    width: 52px;" src="netset_logo.png"
	alt="GHI Resource Plot"
	title="GHI Resource Plot"
	onclick='show(5);'>
	<img style="position: absolute;
    right: 0px;
    top: 250px;
    height: 52px;
	border: solid  1px #888; background-color:rgba(254,159,28,1);
    width: 52px;" src="netset_logo.png"
	alt="DNI Resource Plot"
	title="DNI Resource Plot"
	onclick='show(6);'>
	<img style="position: absolute;
    right: 120px;
    top: 250px;
    height: 52px;
	border: solid  1px #888; background-color:rgba(112,133,16,1);
    width: 52px;" src="img/solar.png"
	alt="Resource Distribution Plots"
	title="Resource Distribution Plots"
	onclick='show(4);'>
	<img style="position: absolute;
    right: 60px;
    top:350px;
    height: 52px;
	border: solid 1px #888;
    width: 52px;" src="stacked.png"
	alt="Timeline"
	title="Timeline"
	onclick='show(1);'>
	<img style="position: absolute;
    right: 0px;
    top: 350px;
    height: 52px;
	border: solid  1px #888;
    width: 52px;" src="tree.png"
	alt="Treemap"
	title="Treemap"
	onclick='show(2);'>
	<img style="position: absolute;
    right: 120px;
    top: 350px;
    height: 52px;
	border: solid  1px #888;
    width: 52px;" src="line.png"
	alt="Line Plot"
	title="Line Plot"
	onclick='show(3);'>
	<a href="http://netset.csaladen.es" target="_self">
	<img class="rotmenu" style="position: absolute;
    right: 40px;
    top: 0px;
	border: none;
    width: 100px;height:100px;" src="netset_logo.png"
	alt="Netset Logo">
	<div style="position: absolute;
    right: 40px;
    top: 110px;
    height: 22px;
	color: #888;
	font-size:20px;
	font-family: Righteous;
	text-align:center;
	white-space: nowrap;
    width: 100px;"/>NETSET 1.0</div></a>
	<div style="position: absolute;
    right: 0px;
    top: 485px;
    height: 2px;
	background-color:#ccc;
	width: 174px;"></div>
	<div style="position: absolute;
    right: 0px;
    top: 330px;
    height: 2px;
	background-color:#ccc;
	width: 174px;"></div>
	<div style="position: absolute;
    right: 0px;
    top: 230px;
    height: 2px;
	background-color:#ccc;
	width: 174px;"></div>
	<div id="social" style="z-index:102;position: absolute;
    right: 0px;
	height:35px;
    top: 505px;">
		<span class='st_facebook_custom'><img class="socialico" src="http://www.iconsdb.com/icons/download/silver/facebook-3-24.ico"></span>
		<!--<span class='st_fblike'></span>-->
		<span class='st_twitter_custom'><img class="socialico" src="http://www.iconsdb.com/icons/download/silver/twitter-3-24.ico"></span>
		<span class='st_googleplus_custom'><img class="socialico" src="http://www.iconsdb.com/icons/download/silver/google-plus-3-24.ico"></span>
		<span class='st_linkedin_custom'><img class="socialico" src="http://www.iconsdb.com/icons/download/silver/linkedin-3-24.ico"></span>
		<!--<span class='st_tumblr_custom'><img class="socialico" src="http://www.iconsdb.com/icons/download/silver/tumblr-3-24.ico"></span>-->
		<!--<span class='st_reddit_custom'><img class="socialico" src="reddit.png"></span>-->
		<span class='st_email_custom'><img class="socialico" src="http://www.iconsdb.com/icons/download/silver/email-13-24.ico"></span>
		<a href="" download="" id="csvdownload" ><span><img class="socialico" src="http://www.iconsdb.com/icons/download/silver/csv-24.ico"></span></a>
		<span id="pngdownloadwrapper"><img class="socialico" src="http://www.iconsdb.com/icons/download/silver/png-24.ico"></span>
	</div>


<a href="http://set.csaladen.es" target="_blank">

<img class="rotmenu" style="position: absolute;
    right: 128px;
    top: 155px;
    height: 38px;
    width: 38px; border:none" alt="NETSET description"
	title="NETSET description" src="desc.png"/>
	<div style="position: absolute;
    right: 134px;
    top: 200px;
    height: 22px;
	font-size:10px;
	font-family: Righteous;
	text-align:center;
	white-space: nowrap;
    width: 40px;"/>description</div></a>
<a href="http://d3plus.org" target="_blank">
<img class="rotmenu" style="position: absolute;
    right: 41px;
    top: 155px;
    height: 38px;
    width: 38px;" alt="Written in Python, simulated in AnyLogic, visualized in D3plus"
	title="Written in Python, simulated in AnyLogic, visualized in D3plus" src="engine.png"/>
	<div style="position: absolute;
    right: 41px;
    top: 200px;
    height: 22px;
	font-size:10px;
	font-family: Righteous;
	text-align:center;
	white-space: nowrap;
    width: 40px;"/>engine</div></a>
<a href="http://www.csaladen.es" target="_blank">
<img class="rotmenu" style="position: absolute;
    right: 0px;
    top: 155px;
    height: 38px;
    width: 38px;" alt="Denes Csala &amp Sgouris Sgouridis &copy; 2016"
	title="Denes Csala &amp Sgouris Sgouridis &copy; 2016" src="credit.png"/>
	<div style="position: absolute;
    right: 0px;
    top: 200px;
    height: 22px;
	font-size:10px;
	font-family: Righteous;
	text-align:center;
	white-space: nowrap;
    width: 40px;"/>credit</div></a>
<a href="http://www.who.int/healthinfo/mortality_data/en/" target="_blank">
<img class="rotmenu" style="position: absolute;
    right: 84px;
    top: 155px;
    height: 38px;
    width: 38px;" alt="Data sources: EIA, BP, UNSD, WDI"
	title="Data sources: EIA, BP, UNSD, WDI" src="netset_data.png"/>
	<div style="position: absolute;
    right: 84px;
    top: 200px;
    height: 22px;
	font-size:10px;
	font-family: Righteous;
	text-align:center;
	white-space: nowrap;
    width: 40px;"/>data</div></a>
	<div style="position: absolute;
    right: 60px;
    top: 308px;
    height: 22px;
	font-size:12px;
	font-family: Righteous;
	text-align:center;
    width: 52px;"
	alt="Timeline"
	title="Timeline"
	onclick='show(5);'>Map</div>
	<div style="position: absolute;
    right: 0px;
    top: 308px;
    height: 22px;
	font-size:12px;
	font-family: Righteous;
	text-align:center;
    width: 52px;"
	alt="Treemap"
	title="Treemap"
	onclick='show(6);'>Matrix</div>
	<div style="position: absolute;
    right: 122px;
    top: 308px;
    height: 22px;
	font-size:12px;
	font-family: Righteous;
	text-align:center;
    width: 52px;"
	alt="Line Plot"
	title="Line Plot"
	onclick='show(4);'>Resource</div>
	<div style="position: absolute;
    right: 60px;
    top: 408px;
    height: 22px;
	font-size:12px;
	font-family: Righteous;
	text-align:center;
    width: 52px;"
	alt="Timeline"
	title="Timeline"
	onclick='show(1);'>Timeline</div>
	<div style="position: absolute;
    right: 0px;
    top: 408px;
    height: 22px;
	font-size:12px;
	font-family: Righteous;
	text-align:center;
    width: 52px;"
	alt="Treemap"
	title="Treemap"
	onclick='show(2);'>Treemap</div>
	<div style="position: absolute;
    right: 120px;
    top: 408px;
    height: 22px;
	font-size:12px;
	font-family: Righteous;
	text-align:center;
    width: 52px;"
	alt="Line Plot"
	title="Line Plot"
	onclick='show(3);'>Line Plot</div>

	<div style="position: absolute;
    right: -5px;
    top: 430px;
    alt="Select Country"
	title="Select Country" id="countrylist"></div>

</div>

<div style="position: fixed; opacity:0;
    left: 5;
    top: 5;
    z-index: 100;" id="viz1" class="viz"></div>
<div style="position: fixed; opacity:0;
    left: 5;
    top: 5;
    z-index: 99;" id="viz2" class="viz"></div>
<div style="position: fixed; opacity:0;
    left: 5;
    top: 5;
    z-index: 99;" id="viz3" class="viz"></div>
<div style="position: fixed; opacity:0;
    left: 5;
    top: 5;
    z-index: 100;" id="viz4" class="viz"></div>
<div style="position: fixed; opacity:0;
    left: 5;
    top: 5;
    z-index: 99;" id="viz5" class="viz"></div>
<div style="position: fixed; opacity:0;
    left: 5;
    top: 5;
    z-index: 99;" id="viz6" class="viz"></div>

<script>
  // sample data array

  var initcountry='Slovakia';
  var initcountrysave=initcountry;
  var initviz=1;
  var sca="linear";
  var center="+";
  var scenario="17";

  function sethash(){
	  scale=(sca=="linear")?0:1;
	  window.location.hash="&viz_"+initviz+"&scale_"+scale+"&scenario_"+scenario+"&country_"+initcountry;
  }
  //hashing, startup, etc
  var hash=window.location.hash;
  if (hash==""){
	sethash();
  }
  else {
	if (hash.indexOf("&country_")>-1) {
		var cloc=hash.search("&country_");
		var cdummy=hash.slice(cloc+9)
		var cloc=cdummy.search("&");
		initcountry=(cloc>-1)?cdummy.slice(0,cloc):cdummy;
	}
	if (hash.indexOf("&viz")>-1) {
		var cloc=hash.search("&viz_");
		initviz=hash.slice(cloc+5,cloc+6)
	}
	if (hash.indexOf("&scale")>-1) {
		var cloc=hash.search("&scale_");
		scale=hash.slice(cloc+7,cloc+8)
	}
	if (hash.indexOf("&scenario")>-1) {
		var cloc=hash.search("&scenario_");
		scenario=hash.slice(cloc+10,cloc+12)
	}
  }
  
  if (initcountry=="None") {
	initcountry=initcountrysave;
  }

  sca=(scale==1)?"share":"linear";

  setTimeout(function(){d3.selectAll(".logo").style("opacity",1)},1000)

  var showd=[true,true,true,true,true,true];

  var visualization = d3plus.viz().container("#viz1")
  var visualization2 = d3plus.viz().container("#viz2")
  var visualization3 = d3plus.viz().container("#viz3")
  var visualization4 = d3plus.viz().container("#viz4")
  var visualization5 = d3plus.viz().container("#viz5")
  var visualization6 = d3plus.viz().container("#viz6")

  var load=function(){};

  function show(a){

    initviz=a;
    sethash();

	d3.select("#viz1").style("opacity",0);
	d3.select("#viz2").style("opacity",0);
	d3.select("#viz3").style("opacity",0);
	d3.select("#viz4").style("opacity",0);
	d3.select("#viz5").style("opacity",0);
	d3.select("#viz6").style("opacity",0);
	d3.select("#viz1").style("z-index",99);
	d3.select("#viz2").style("z-index",99);
	d3.select("#viz3").style("z-index",99);
	d3.select("#viz4").style("z-index",99);
	d3.select("#viz5").style("z-index",99);
	d3.select("#viz6").style("z-index",99);
	
	d3.select("#viz"+a).style("z-index",100);
	d3.select("#viz"+a).style("opacity",1);

	if (showd[a-1]) { //draw if on first clikc/load
		load(initcountry,a);
		showd[a-1]=false;
	}
  }

  //var path="http://localhost:7777/Set/json/"; //localserver for dev
  var path = "https://dl.dropboxusercontent.com/u/531697/datarepo/Set/"
  var path= "" //local
  path = path + "json/"+scenario+"/" //default
  
  function getByName(arr, value) {
		   for (var i=0, iLen=Object.keys(arr).length; i<iLen; i++) {
			  if (arr[Object.keys(arr)[i]] == value) return Object.keys(arr)[i];
		   }
		}
  
  JSZipUtils.getBinaryContent('universal/res.zip', function(err, rawres) {
  
  var zip = new JSZip(rawres);
  var res=JSON.parse(zip.files['res.json'].asText());	  
  
  d3.json('universal/clrs.json',function(clrs){
  d3.json('universal/isoico.json',function(isoico){
  d3.json('universal/risoico.json',function(risoico){
  d3.json('universal/pop.json',function(pop){
  d3.json('universal/matrix.json',function(matrix){
  d3.json('universal/isocountries.json',function(isocountries){
  //d3.json('universal/risocountries.json',function(risocountries){
  d3.json('flags/isocolors.json',function(isocolors){ //colors with http://mkweb.bcgsc.ca/color-summarizer/?url=http://netset.csaladen.es/flags/'+i+'&precision=vlow&text=1&num_clusters=5
  d3.json('universal/isocountries2.json',function(isocountries2){
  d3.json('universal/countries.json',function(countries){
  d3.json('universal/labeler.json',function(labeler){
  
  risocountries=[];//this is only used for the world map
  Object.keys(isocountries).forEach(function(d){
	risocountries[isocountries[d]]=parseInt(d);
  })
  //corrections
  risocountries["United States of America"]=840;
  isocountries[840]="United States of America"
  risocountries["Greenland"]=304;
  isocountries[304]="Greenland";
  risocountries["France"]=250;
  isocountries[250]="France";
  risocountries["Italy"]=380;
  isocountries[380]="Italy";
  risocountries["Norway"]=578;
  isocountries[578]="Norway";
  risocountries["Germany"]=276;
  isocountries[276]="Germany";
  risocountries["India"]=356;
  isocountries[356]="India";
  risocountries["Sudan"]=729;
  isocountries[729]="Sudan";
  risocountries["South Sudan"]=728;
  isocountries[728]="South Sudan";
  risocountries["Viet Nam"]=704;
  isocountries[704]="Viet Nam";
  risocountries["Yemen"]=887;
  isocountries[887]="Yemen";
  risocountries["Switzerland"]=756;
  isocountries[756]="Switzerland";
  risocountries["Panama"]=591;
  isocountries[591]="Panama";
  risocountries["Puerto Rico"]=630;
  isocountries[630]="Puerto Rico";
  risocountries["Serbia"]=688;
  isocountries[688]="Serbia";
  
  isoico["Greenland"]="DK";
  isoico["Puerto Rico"]="US";
  isoico["South Sudan"]="ZZ";  
  isoico["Yemen"]="YE";  
  
  var geodata=[]; //construct geodata for map plotter
  Object.keys(pop).forEach(function(d){
	Object.keys(pop[d]).forEach(function(e){
		geodata.push({"year":e,"pop":pop[d][e],"country":d,"id":risocountries[d]});
	})
  })
  
  JSZipUtils.getBinaryContent(path+initcountry+'.zip', function(err, rawdata) {
	
	var order={
		"coal":30,
		"oil":27,
		"gas":24,
		"biofuels":18,
		'nuclear':21,
		'hydro':20,
		'geo_other':22,
		'solar':14,
		'wind':15,
		'csp':13,
		'electricity':16,
		'Power-to-liquid':17,
		'storage':19
	  }

	  var ucolor={
		"coal":d3.rgb(85,20,52),
		"oil":d3.rgb(131,13,9),
		"gas":d3.rgb(217,20,14),
		"biofuels":d3.rgb(64,185,85),
		'nuclear':d3.rgb(179,0,45),
		'hydro':d3.rgb(202,200,46),
		'geo_other':d3.rgb(106,23,9),
		'solar':d3.rgb(251,212,31),
		'wind':d3.rgb(112,133,16),
		'csp':d3.rgb(254,159,28),
		'electricity':d3.rgb(0,140,70),
		'grid':d3.rgb(0,140,70),
		'Power-to-liquid':d3.rgb(213,9,98),
		'storage':d3.rgb(32,32,47)
	   }
	   
	   var heatmap2=[ucolor["csp"],ucolor["solar"],ucolor["wind"],ucolor["electricity"],ucolor["Power-to-liquid"],ucolor["biofuels"],ucolor["storage"],ucolor["hydro"],ucolor["nuclear"],ucolor["geo_other"],ucolor["gas"],ucolor["oil"],ucolor["coal"]];
	   
	   var heatmap=[
			"#006837",
			"#31a354",
			"#78c679",
			"#c2e699",
			"#fed98e",
			"#fe9929",
			"#d95f0e",
			"#993404",
			"#980043",
			"#dd1c77",
			"#df65b0"];
	   
	   var q1color={
		"Production":d3.rgb(112,133,16),
		"Consumption":d3.rgb(179,0,45),
		"Import":d3.rgb(202,200,46),
		"Export":d3.rgb(85,20,52),
		'Re-Import':d3.rgb(251,212,31),
		'Re-Export':d3.rgb(213,9,98)
	   }
	   
	   var gcolor={
		"fossil fuels":d3.rgb(131,13,9),
		"scale limited":d3.rgb(202,200,46),
		'solar':d3.rgb(251,212,31),
		"traded & stored":d3.rgb(0,140,70)
	   }

	   var group={
	    "coal":"fossil fuels",
		"oil":"fossil fuels",
		"gas":"fossil fuels",
		"biofuels":"scale limited",
		'nuclear':"scale limited",
		'hydro':"scale limited",
		'geo_other':"renewables",
		'solar':"renewables",
		'wind':"renewables",
		'csp':"renewables",
		"electricity":"traded & stored",
		'Power-to-liquid':"traded & stored"
	   }
	   
	  var tradeway={"ptl":"Power-to-liquid","grid":"grid"}
	  var by={"Import":"from","Export":"to","Re-Import":"from","Re-Export":"to","Production":"by","Consumption":"by"}
			
	  function extend(rawdata){
		  var zip = new JSZip(rawdata);
		  var data=JSON.parse(zip.files['data.json'].asText());
		  var cod2=getByName(isocountries,initcountry);
		  
		  data.forEach(function(d) {
			//set q2 level country flags and dominant colors
			//set flow direction
			if (d["q1"]=="pp") d["q1"]="Production";
			if (d["q1"]=="cc") d["q1"]="Consumption";
			if (d["q2"]==999) d["q2"]=initcountry
			else d["q2"]=isocountries[d["q2"]];
			if (d["q2"]==initcountry) { //self-trade
				if (d["q1"]=="Import") d["q1"]="Production";
				if (d["q1"]=="Export") d["q1"]="Consumption";
			}
			//bottom-most level
			d["q3"]=d["u"]+"_";
			//sepparate trade fuel from source
			if (d["u"].search('_')>0) {
				if (d["u"].search('geo_')<0) {
					//console.log(d["u"])
					if (d["q2"]!=initcountry) {
						d["u"]=tradeway[d["u"].slice(0,d["u"].search('_'))]						
					} else{
						d["u"]=d["u"].slice(0,d["u"].search(' '))
					}
				}
				d["q3"]=d["q3"].slice(d["q3"].search('_')+1)
			} 
			d["q3"]=d["q3"].slice(0,d["q3"].search('_'))
			//setdisplay order
			d["order"]=(d["g"]=="f")?"f"+(40-order[d["u"]]):"f"+(40-order[d["u"]]); //set both to a for next to each other ordering
			d["order2"]=(d["g"]=="f")?"f"+(40-order[d["u"]]):"b"+(order[d["u"]]); //set both to
			//add genders and population (prod/cons)
			d["s+"]=(d["g"]=="f")?d["s"]:-d["s"];
			d["s"]=Math.abs(d["s+"])
			d[d["g"]]=d["s"];
			d[d["g"]+"+"]=d["s+"];
			//fix category mismatches
			if (d["u"]=="pv") d["u"]="solar";
			if (d["q3"]=="pv") d["q3"]="solar";
			if (d["u"]=="electricity") {
				d["u"]="grid";
				d["q3"]="electricity";
			}
			//set colors and icons
			d["ucolor"]=ucolor[d["u"]];
			d["group"]=group[d["u"]];
			d["uicon"]="img/"+d["u"]+".png";
			
			if (initcountry in pop)
				if (d["t"] in pop[initcountry]) {
					d["ps"]=d["s"]*1000000000000.0/8760/pop[initcountry][d["t"]]; //per capita, unit conversion from TWh to Wh
					d["p"+d["g"]]=d["ps"];
					d["ps+"]=d["s+"]*1000000000000.0/8760/pop[initcountry][d["t"]]; //per capita, unit conversion to yearly avg power
					d["p"+d["g"]+"+"]=d["ps+"];
				} else console.log("No population data for:",initcountry,d["t"]);
		  });
		  
		  if (!(initcountry in pop)) console.log("No population data for:",initcountry,"all years");
		  
		  return data;
	  }

	  function cap1(string) {
		return string.charAt(0).toUpperCase() + string.slice(1);
	  }

	  function textformatter(text, params) {

			if (text.indexOf("&group") > -1) text=text.slice(9);
			
			if (Object.keys(labeler).indexOf(text)>-1){
				return labeler[text];
			}

			if (text === "t") {
			  return "Year";
			}
			if (text === "pv") {
			  return "Photovoltaic";
			}
			if (text === "biofuels") {
			  return "Bioenergy";
			}
			if (text === "electricity") {
			  return "Traded Electricity";
			}
			if (text === "grid") {
			  return "Traded Electricity";
			}
			if (text === "csp") {
			  return "Solar Thermal";
			}
			if (text === "solar") {
			  return "Photovoltaic";
			}
			else if (text === "s") {
			  return "Energy";
			}
			else if (text === "s+") {
			  return "Energy";
			}
			else if (text === "f") {
			  return "Inflow";
			}
			else if (text === "m") {
			  return "Outflow";

			}
			else if (text === "f+") {
			  return "Inflow";
			}
			else if (text === "m+") {
			  return "Outflow";

			}
			else if (text === "pf") {
			  return "Power / Capita";
			}
			else if (text === "pm") {
			  return "Power / Capita";
			}
			else if (text === "ps") {
			  return "Power / Capita";
			}
			else if (text === "pf+") {
			  return "Power / Capita";
			}
			else if (text === "pm+") {
			  return "Power / Capita";
			}
			else if (text === "ps+") {
			  return "Power / Capita";
			}
			else if (text === "geo_other") {
			  return "Other";
			}
			else if (text === "pop") {
			  return "Population";
			}
			else {
			  return d3plus.string.title(text, params);
			}
	  };

	  function numberformatter(number, params) {

	    number=Math.abs(number);

        var formatted = d3plus.number.format(number, params);

		return formatted// + ((val=="")?" TWh":" W");
        
      };

	  function vfunc(val,gen,center) {
		return val+gen+((sca=="share")?"":center);
	  }
	  
	  data=extend(rawdata);

	  var countrylist=[];
	  countries.sort().forEach(function(d,i) {
		var dummy={"country":d};
		countrylist.push(dummy);
	  });
	  
	  var val="";
	  var gen="s";
	  var val3="";
	  var gen3="s+";
	  var val2="";
	  var gen2="s";
	  var sub={"m":"Outflow","f":"Inflow"};
	  var title={"font":{"size":20}};
	  var font = {"family":"Righteous","size":15};

	  var countrydrop = d3plus.form()
		.data(countrylist)
		.container("#countrylist")
		.font({"family":"Righteous","size":15,"align":"center","secondary":{"family":"Righteous"}})
		.id("country")
		.width(174)
		.text("country")
		.focus(initcountry,function(d){
			showd=[true,true,true];
			showd[initviz-1]=false;
			load(d,initviz);
		})
		.type("drop")
		.draw()

	  d3.select("#pngdownloadwrapper")
		.on("click",function(){
			seturl();
			setTimeout(function(){d3.select("#pngdownload").node().click();},500);
		})

	  function seturl(){
		exportInlineSVG(d3.select("#viz"+initviz).select("#d3plus").node(), function(data) {
			d3.select("#pngdownload").node().href=data;
			d3.select("#pngdownload").node().download=initcountry+"_"+initviz+".png";
		});
	  }

	  function ylabeler() {
		var v3=(sca=="share")?"Share":(val=="")?"Energy [TWh]":"Power/Capita [W]"
		if (center=="+") v3="Outflows · · · · ·  · · · "+v3+" · · · · · · Inflows";
		return v3;
	  }
	  
	  visualization
		.type("stacked")    // visualization type
		.data({"value":data,"visibility":"hidden"})
		.id({"value":["g","group","u","q1","q2","q3"]})//,"mute":["Women","Men"]})         // key for which our data is unique on
		.aggs({"t": "mean"})
		.depth(2)
		.y({"value":"s"+((sca=="share")?"":center),"label":ylabeler(),"scale":sca})//,"range":[0,2*shifter]})         // key to use for y-axis
		.x({"value":"t","label":"Year"})          // key to use for x-axis
		.time({"value":"t","solo":d3.range(1965,2101)})
		.color(function(d){
			if (d.d3plus.depth==1) return gcolor[d["group"]];
			if (d.d3plus.depth==3) return q1color[d["q1"]];
			if (d.d3plus.depth==4) return clrs[d["q2"]];
			if (d.d3plus.depth==5) return ucolor[d["q3"]];
			return d["ucolor"];
		})
		.order({"value":((center=="+")&&(sca=="share"))?"order2":"order","sort":"asc"})
		.margin("0px 30px 10px 20px")
		.font(font)
		.icon({"style": "knockout","value": (function(d){
			if (d.d3plus.depth==1) return "img/"+d["group"]+".png";
			if (d.d3plus.depth==3) return"img/"+d["q1"]+".png";
			if (d.d3plus.depth==4) return 'flags/'+isoico[d["q2"]]+'.png';
			if (d.d3plus.depth==5) return "img/"+d["q3"]+".png";
			return d["uicon"]
		})})
		.legend({"filters":true,"size":30})
		.messages({"style":false,"branding":false})
		.axes({"background": {"color": "#eee"}})
		.shape({"interpolate": "basis"}) //basis or linear
		.title({"value":initcountry,"sub":"Sustainable Energy Transitions Exploratorium | Timeline | " + ((center=="")?"Stacked Area":"Violin Plot")})
		.title(title)
		.ui({"font":{"size":12},"value":[
		  {
			"method" : "depth",
			"value"  :[{"Aggregate":1}, {"Source":2} ],
			"label" : " "
		  },
	      {
			"method" : function(value){
			  sca=value;
			  sethash();
			  visualization
			  .order({"value":((center=="+")&&(sca=="share"))?"order2":"order"})
			  .y(vfunc(val,gen,center))
			  .y({"scale": value})
			  .y({"label": ylabeler()})
			  .draw()
			},
			"value"  : [ {"Values":"linear"},{"Share":"share"}],
			"label" : " "
		  },
	      {
			"method" : function(value){
			  center=(value=="s")?"":"+";
			  visualization
			  .title({"sub":"Sustainable Energy Transitions Exploratorium | Timeline | " + ((center=="")?"Stacked Area":"Violin Plot")})
			  .order({"value":((center=="+")&&(sca=="share"))?"order2":"order"})
			  .y({"label": ylabeler()})
			  .y(vfunc(val,gen,center))
			  .draw()
			},
			"value"  : [ {"Violin":"g"}, {"Stack":"s"}],
			"label" : " "
		  },
		  {
			"method" : function(value){
			  val=(value=="s")?"":"p";
			  visualization
			  .y(vfunc(val,gen,center))
			  .y({"label":ylabeler()})
			  .draw();
			},
			"value"  :[{"Energy":"s"} , {"Power/Capita":"p"}],
			"label" : " "
		  },
		  {
			"method" : function(value){
			  gen=value;
			  visualization
			  .y(vfunc(val,gen,center))
			  .draw();
			},
			"value"  : [{"Both":"s"},{"Inflows":"f"}, {"Outflows":"m"}],
			"label" : " "
		  }
		]})
		.tooltip({"sub":function(d){
			//console.log(d);
			if (d["g"]=="m")
				visualization
				.tooltip({"background":"#ededed"});
			else	visualization
				.tooltip({"background":"#dedede"});
			return sub[d["g"]];
		},"value":["t"]})
		.format({
		  "text": function(text, params) {
			  return textformatter(text, params);
		  },
		  "number": function(number, params) {
			  return numberformatter(number, params);
          }
		  })
		//.draw()             // finally, draw the visualization!
	
		visualization3
		.type("line")    // visualization type
		.data({"value":data,"stroke":{"width":4}})
		.id({"value":["supergroup","supergroup","group","u","q1","q2","q3"]})         // key for which our data is unique on
		.aggs({"t": "mean"})
		.depth(3)
		.y({"value":"s+","label":"Energy [TWh]","scale":"linear"})         // key to use for y-axis
		.x({"value":"t","label":"Year"})          // key to use for x-axis
		.time({"value":"t","solo":d3.range(1965,2100)})
		.color("ucolor")
		.font(font)
		.margin("0px 30px 10px 20px")
		.icon({"style": "knockout","value": "uicon"})
		.legend({"filters":true,"size":30})
		.messages({"style":false,"branding":false})
		.axes({"background": {"color": "#eee"}})
		.shape({"interpolate": "linear"})  //basis
		.title({"value":initcountry,"sub":{"value":"Sustainable Energy Transitions Exploratorium | Line Plot"}})
		.title(title)
		.ui({"font":{"size":12},"value":[
		  {
			"method" : "depth",
			"value"  :[{"All":1}, {"Type":2}, {"Source":3} ],
			"label" : " "
		  },
		  {
			"method" : function(value){
			  var v3=(value=="s+")?"Energy [TWh]":"Power/Capita [W]"
			  val3=(value=="s+")?"":"p";
			  visualization3
			  .y(vfunc(val3,gen3,""))
			  .y({"label":v3})
			  .draw();
			},
			"value"  :[{"Energy":"s+"} , {"Power/Capita":"p"}],
			"label" : " "
		  },
		  {
			"method" : function(value){
			  gen3=value;
			  visualization3
			  .y(vfunc(val3,gen3,""))
			  .draw();
			},
			"value"  : [{"Net":"s+"},{"Inflows":"f"}, {"Outflows":"m"}],
			"label" : " "
		  }
		]})
		.tooltip({"sub":function(d){
			if (d["g"]=="m")
				visualization3
				.tooltip({"background":"#ededed"});
			else	visualization3
				.tooltip({"background":"#dedede"});
			return sub[d["g"]];
		},"value":["t"]})
		.format({
		  "text": function(text, params) {
			  return textformatter(text, params);
		  },
		  "number": function(number, params) {
			  return numberformatter(number, params);
          }
		  })
		//.draw()             // finally, draw the visualization!


		visualization2
		.type("tree_map")    // visualization type
		.data(data)
		.id({"value":["group","group","u","q1","q2","q3"],"grouping": true })         // key for which our data is unique on
		.aggs({"s":"sum"})
		.depth(2)
		.size({"value":"f"})         // key to use for y-axis
		.time({"value":"t","solo":d3.range(2010,2015)})
		.color(function(d){
			if (d.d3plus.depth==1) return d["gcolor"];
			if (d.d3plus.depth==3) return d["q1color"];
			if (d.d3plus.depth==4) return d["q2"];
			if (d.d3plus.depth==5) return d["q3color"];
			return d["ucolor"];
		})      // color legend
		.font(font)
		.margin("0px 40px 10px 30px")
		.icon({"style": "knockout","value": (function(d){
			if (d.d3plus.depth==1) return d["gicon"];
			if (d.d3plus.depth==3) return d["q1icon"];
			if (d.d3plus.depth==4) return d["q2icon"];
			if (d.d3plus.depth==5) return d["q3icon"];
			return d["uicon"]
		})})
		.legend({"filters":true,"size":30})
		.messages({"style":false,"branding":false})
		.title({"value":initcountry,"sub":{"value":"Sustainable Energy Transitions Exploratorium | Treemap"}})
		.title(title)
		.labels({"align": "left", "valign": "top","padding":20})
		.ui({"font":{"size":12},"value":[
		  {
			"method" : "depth",
			"value"  :[{"Type":1}, {"Source":2} ],
			"label" : " "
		  },
		  /*
		  {
			"method" : function(value){
			  val2=(value=="s")?"":"p";
			  visualization2
			  .size(vfunc(gen2,val2,""))
			  .draw();
			},
			"value"  :[{"Energy":"s"} , {"Power/Capita":"p"}],
			"label" : " "
		  },
		  */
		  {
			"method" : function(value){
			  gen2=value;
			  visualization2
			  .size(vfunc(gen2,val2,""))
			  .draw();
			},
			"value"  : [{"Inflows":"f"}, {"Outflows":"m"}],
			"label" : " "
		  }
		]})
		.tooltip({"sub":function(d){
			if (d["g"]=="m")
				visualization2
				.tooltip({"background":"#ededed"});
			else	visualization2
				.tooltip({"background":"#dedede"});
			return sub[d["g"]];
		}})
		.format({
		  "text": function(text, params) {
			 return textformatter(text, params);
		  },
		  "number":function(number, params) {
			 return numberformatter(number, params);
          }
		  })
		//.draw()

		firstrun=false;
		firstrun4=false;

		load=function(country,viz) {
		
		  if (country=="None") {
			console.log(country,viz,initcountry);
		  }
		
		  d3.select("#csvdownload").node().href=path+country+'.zip';
		  d3.select("#csvdownload").node().download=country+'.zip';
		  d3.select("#pngdownload").node().download=country+"_"+initviz+".png";

		
		  if (viz<4) {
		
			  country=country.replace('/','&&')
			  // instantiate JSZip, load and unzip data
			  JSZipUtils.getBinaryContent(path+country+'.zip', function(err, rawdata) {

			  if (firstrun){
				initcountry=country;
				data=extend(rawdata);
			  }

			  sethash();
			  //seturl();
			  ((viz==1) ? visualization : (viz==2) ? visualization2 : visualization3)
				  .data(data)
				  .title(country)
				  .draw()

			  firstrun=true;

			  })

		    } else if (viz==4) {
			 
			   initcountry=country;	
			 
			   if (!(firstrun4)){
				country="None";
				firstrun4=true;
			   }
				
			   visualization4
			    .id({"solo":country})
			    .draw()
				
				sethash();
				
			} else if (viz==5) {
				
				visualization5
				.draw();
				
			} else if (viz==6) {
				
				visualization6
				.draw();
				
			}
		
		};
		
		resinit="pv";
		instinit="res";
		restitledict={"wind":"Global Distribution of Wind Energy",
		"pv":"Global Distribution of Photovoltaic Energy",
		"csp":"Global Distribution of Solar Thermal Energy"};
		restitledict2={"res":" Resources","inst":" Generation"};
		ressubtitledict={"res":{"wind":"Onshore (0-100 miles) + Offshore (5-50 nautical miles) | 90m hub height | 5MW / sqkm",
		"pv":"10% overall conversion efficiency | covering 1.5% of productive land in each country",
		"csp":"6 hours of storage | 31MW / sqkm"},"inst":{"wind":"","pv":"","csp":""}};
		instlabeldict={"res":"Available Energy [TWh / Year]","inst":"Generated Energy [TWh / Year]"};
		
		visualization4
			.data(res[instinit][resinit])  // data to use with the visualization
			.type("stacked")    // visualization type
			.id(["country","country"])         // key for which our data is unique on
			.order("country")
			.color(function(d){
				//return d3plus.color.lighter(clrs[d["country"]],0.3);
				return clrs[d["country"]];
			})
			.icon(function(d){
				return 'flags/'+isoico[d["country"]]+'.png';
			})
			.format({
			  "text": function(text, params) {
				  return textformatter(text, params);
			  },
			  "number": function(number, params) {
				  return numberformatter(number, params);
			  }
			  })
			.legend({"filters":true,"size":30})
			.font(font)
			.ui({"font":{"size":12},"value":[
			  {
				"method" : function(value){
				  resinit=value;
				  visualization4
				  .data(res[instinit][resinit])
				  .title({"value":restitledict[resinit]+restitledict2[instinit],"sub":ressubtitledict[instinit][resinit]})
				  .draw()
				},
				"value"  : [ {"Photovoltaic":"pv"},{"Solar Thermal":"csp"},{"Wind":"wind"}],
				"label" : " "
			  },
			  {
				"method" : function(value){
				  instinit=value;
				  visualization4
				  .data(res[instinit][resinit])
				  .title({"value":restitledict[resinit]+restitledict2[instinit],"sub":ressubtitledict[instinit][resinit]})
				  .y({"label":instlabeldict[value],"sub":instlabeldict[value]})
				  .draw()
				},
				"value"  : [ {"Resource":"res"},{"Generation":"inst"}],
				"label" : " "
			  },
			  {
				"method" : function(value){
				  sca=value;
				  sethash();
				  visualization4
				  .y({"scale": value})
				  .draw()
				},
				"value"  : [ {"Values":"linear"},{"Share":"share"}],
				"label" : " "
			  },{
				"method" : function(value){
				  visualization4
				  .id({"solo":[]})
				  .draw()
				},
				"value"  : [ {"Reset all":"0"}],
				"label" : " "
			  }]
			  })
			.title({"value":restitledict[resinit]+restitledict2[instinit],"sub":ressubtitledict[instinit][resinit]})
			.title(title)
			.margin("0px 40px 10px 30px")
			//.shape({"interpolate": "basis"}) //basis or linear
			.x({"value":"class","label":"Resource Quality Distribution [decile]"})         // key for x-axis
			.y({"value":"value","label":instlabeldict[instinit],"scale":sca})        // key for y-axis
			.aggs({"class": "mean"})
			.time({"value":"year","solo":[2014]})
			//.draw()             // finally, draw the visualization!
		
		visualization5
			.data(geodata)        // data to use with the visualization
			.coords({"value":"universal/world3.json","projection":"times","mute":[10]})// pass topojson coordinates
			.type("geo_map")          // visualization type
			.id({"value":"id"})            // key for which our data is unique on
			.text("country")             // key to use for display text
			//.color({"value":"pop"})           // key for coloring countries
			.color(function(d){
				return clrs[isocountries[d["id"]]];
			})           // key for coloring countries
			.color({"heatmap":heatmap})
			.aggs({"pop":"mean","year":"mean"})
			.time({"value":"year","solo":[2014],"mute":d3.range(2015,2101)})
			.title({"value":'Global Chloropleth Maps',"sub":''})
			.title(title)
			.font(font)
			.icon(function(d){
				return 'flags/'+isoico[isocountries[d["id"]]]+'.png';
			})
			.tooltip(["pop"])
			.legend({"filters":true,"size":30})
			.format({
			  "text": function(text, params) {
				  return textformatter(text, params);
			  },
			  "number": function(number, params) {
				  return numberformatter(number, params);
			  }
			  })
			.margin("0px 10px 0px 0px")
			.ui({"font":{"size":12},"value":[
			  {
				"method" : function(value){
				  resinit=value;
				  visualization5
				  //.data(res[instinit][resinit])
				  .title({"value":restitledict[resinit]+restitledict2[instinit],"sub":ressubtitledict[instinit][resinit]+' [TWh per Year]'})
				  .draw()
				},
				"value"  : [ {"Photovoltaic":"pv"},{"Solar Thermal":"csp"},{"Wind":"wind"}],
				"label" : " "
			  },
			  {
				"method" : function(value){
				  instinit=value;
				  visualization5
				  //.data(res[instinit][resinit])
				  .title({"value":restitledict[resinit]+restitledict2[instinit],"sub":ressubtitledict[instinit][resinit] +' [TWh per Year]'})
				  //.y({"label":instlabeldict[value],"sub":instlabeldict[value]})
				  .draw()
				},
				"value"  : [ {"Resource":"res"},{"Generation":"inst"}],
				"label" : " "
			  },
			  {
				"method" : function(value){
				  visualization5
				  .color({"value":"pop"})
				  .title({"value":'Population Chloropleth Map',"sub":' [people]'})
				  .draw()
				},
				"value"  : [ {"Population":"pop"}],
				"label" : " "
			  },
			  {
				"method" : function(value){
				  visualization5
				  .color(function(d){
						return clrs[isocountries[d["id"]]];
					})
				  .title({"value":'Global Chloropleth Maps',"sub":''})
				  .draw()
				},
				"value"  : [ {"Colors":"colors"}],
				"label" : " "
			  }]
			  })
			  //.draw()
			
		var mdata = [
			{"index":"a", "foo":20, "bar":5, "baz":77},
			{"index":"b", "foo":2, "bar":20},
			{"index":"c", "foo":94, "bar":55, "baz":101},
			{"index":"d", "bar":95, "baz":82}
		  ]
			
		visualization6
			.data(matrix["matrix"])
			.type("table")
			.id("index")
			.shape("square")
			.cols(matrix["cols"])
			.color({"heatmap":heatmap})
			.margin("0px 40px 10px 30px")
			//.time({"value":"year","solo":[2014],"mute":d3.range(2015,2101)})
			.title({"value":'Partner Importance of COLUMN Country for ROW Country in Energy Trade',"sub":''})
			.title(title)
			.font(font)
			.tooltip(function(d){
				console.log(d)
			})
			.tooltip([function(d){
				return 'Importance of '+
				labeler[risoico[d.d3plus.id.slice(7).toUpperCase()]]+' for ' +
				labeler[risoico[d.d3plus.id.slice(4,6).toUpperCase()]]
			}])
			//.legend({"filters":true,"size":30})
			.format({
			  "text": function(text, params) {
				  return textformatter(text, params);
			  },
			  "number": function(number, params) {
				  return numberformatter(number, params);
			  }
			  })
			//.draw()             // finally, draw the visualization!
		
		show(initviz); //initialize viz;
		setTimeout(function(){seturl()},15000)
		
  })
  })
  })
  })
  })
  })
  })
  })
  })
  })
  })
  })
</script>
</body>
</html>
